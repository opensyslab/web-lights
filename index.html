<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
       "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>WebLights</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"/>
<script type="text/javascript" src="lib/jquery-1.11.1.min.js"></script>
<script type="text/javascript" src="lib/raphael-min.js"></script>
<script type="text/javascript" src="lib/colorwheel.js"></script>
<link rel="stylesheet" href="style.css" type="text/css">

</head>
<body style="background-color:#5E5E5E">

<div id="scenes">
    
</div>

<div id="switches">
<!--
	<div class="rfpower" id="rf1">
		<span class="label">Regal</span>
		<a class="on" href='javascript:set_power("11011","1","true")'>ON</a>
		<a class="off" href='javascript:set_power("11011","1","false")'>OFF</a>
	</div>

	<div class="rfpower" id="rf2">
		<span class="label">Sofa Tisch</span>
		<a class="on" href='javascript:set_power("11011","2","true")'>ON</a>
		<a class="off" href='javascript:set_power("11011","2","false")'>OFF</a>
	</div>

	<div class="rfpower" id="rf3">
		<span class="label">Esszimmer</span>
		<a class="on" href='javascript:set_power("11011","3","true")'>ON</a>
		<a class="off" href='javascript:set_power("11011","3","false")'>OFF</a>
	</div>
-->
</div>

<div id="color_picker">

	<span class="label">Sofa RGB</span>
	<div id="color_controls">
		<img id="powerbutton" src="gfx/power.png"/>
		<div id="colorwheel" ></div>
	</div>

</div>

<script type="text/javascript" charset="utf-8">
// Global

$(document).ready(function () 
{
	//init_scenes();
    init_power();
    init_ola();
	
	
});

$(window).resize(function () 
{
	init_ola();
});

// SCENES
function init_scenes()
{
    get_scenes();
}

function set_scene(name)
{

	$.get("scenes.set?load="+name);
}

function delete_scene(name)
{

	$.get("scenes.set?delete="+name);
    get_scenes();
}

function save_scene()
{
    var sceneName = window.prompt("Please enter a scene name","");
	$.get("scenes.set?save="+sceneName+"&plugin=ola&plugin=rfpower");
    get_scenes();
}

function get_scenes()
{
  $.getJSON("/scenes.get", function(data){
	if(data)
	{
		var scenes = data['scenes'];
		var cont = $('#scenes');
		cont.empty();
        cont.append('<span class="label">Scenes</span>');
        cont.append(('<div class="scene"><span class="label"><a href=\'javascript:save_scene()\' >+Save Scene+</a></span></div>'));
        
        
		for (i = 0; i < scenes.length; i++)
		{
			var scene = scenes[i];
			var scont = $('<div class="scene"></div>');
            var scont_row = $('<span class="label"></span>');
            
            

			scont_row.append('<a href=\'javascript:set_scene("'+ scene.name +'")\' >'+scene.name+'</a>');
            scont_row.append('<a href=\'javascript:delete_scene("'+ scene.name +'")\' > (delete)</a>');
            scont.append(scont_row);

			cont.append(scont);
				
		}
		//alert(data['units']);
	}
  });
}

// RFPOWER

function init_power()
{
	get_power();
}

function set_power(base,unit,state)
{

	$.get("rfpower.set?base="+base+"&unit="+unit+"&state="+state);
}

function get_power()
{
  $.getJSON("/rfpower.get", function(data){
	if(data)
	{
		var units = data['units'];
		var cont = $('#switches');
		cont.empty();
		for (i = 0; i < units.length; i++)
		{
			var unit = units[i];
			rfcont = $('<div class="rfpower"></div>');

			rfcont.append('<span class="label">'+unit.name+'</span>');
			rfcont.append('<a class="on" href=\'javascript:set_power("'+unit.base+'","'+unit.unit+'","true")\'>ON</a>');
			rfcont.append('<a class="off" href=\'javascript:set_power("'+unit.base+'","'+unit.unit+'","false")\'>OFF</a>');

			cont.append(rfcont);
				
		}
		//alert(data['units']);
	}
  });
}

// OLA

var cw;



function set_color(r,g,b)
{
  $.get("/ola.set?r=" + r + "&g=" + g + "&b=" + b);
//  set_colorwheel_color(r,g,b); // prevents "skipping" of cursor when value is loaded
}

function get_color()
{
  $.getJSON("/ola.get", function(data){
	set_colorwheel_color(parseInt(data['r']),parseInt(data['g']),parseInt(data['b']));
  });
}

function set_colorwheel_color(r,g,b)
{
	cw.color("rgb(" + r + "," + g + "," + b + ")");
}

function init_ola()
{
  var size = Math.min($(window).width(), $(window).height()) * 0.9
  $("#colorwheel").empty();
  cw = Raphael.colorwheel($("#colorwheel")[0],size);
  get_color(); // async
  
  //cw.input($("#input")[0]);

  cw.ondrag(function(){}, function(){set_color(parseInt(cw.color().r), parseInt(cw.color().g), parseInt(cw.color().b) )});
  
  $('#powerbutton').width(size * 0.15);
  $('#powerbutton').height(size * 0.15);
  $('#powerbutton').on('click', function(){
	set_color(0,0,0);
	});

  
}

  
</script>
	</body>
	</html>
